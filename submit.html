<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Music â€” Before The Data</title>
  <meta name="description" content="Submit your music to Before The Data. Chad listens to everything personally.">
  <link rel="canonical" href="https://beforethedata.com/submit.html">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://beforethedata.com/submit.html">
  <meta property="og:title" content="Submit Music â€” Before The Data">
  <meta property="og:description" content="Chad listens to everything personally.">
  <meta property="og:image" content="https://beforethedata.com/assets/og-image.jpg">
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    .submit-wrap { max-width: 560px; margin: 0 auto; padding: 40px 24px 80px; }
    .submit-header { margin-bottom: 40px; }
    .submit-header h1 {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 52px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1px; line-height: 1; margin: 0 0 12px;
    }
    .submit-header p { font-size: 15px; color: #555; line-height: 1.6; margin: 0; }

    .step-block { display: none; animation: fadeIn 0.25s ease; }
    .step-block.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

    .submit-card {
      border: 1px solid #e8e8e8; padding: 32px; margin-bottom: 24px;
    }
    .submit-card h2 {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 28px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; margin: 0 0 8px; color: #000;
    }
    .submit-card p { font-size: 14px; color: #555; line-height: 1.6; margin: 0 0 24px; }

    /* Tier toggle */
    .tier-toggle {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; margin-top: 14px;
    }
    .tier-option {
      border: 2px solid #e8e8e8; padding: 20px 16px; cursor: pointer;
      transition: border-color 0.15s, background 0.15s; position: relative;
      text-align: center;
    }
    #tier-paid { padding-top: 28px; }
    .tier-option:hover { border-color: #ccc; }
    .tier-option.selected { border-color: #000; background: #000; color: #fff; }
    .tier-option.selected .tier-label { color: #fff; }
    .tier-option.selected .tier-price { color: #fff; }
    .tier-option.selected .tier-desc { color: #aaa; }
    .tier-badge {
      position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
      background: #000; color: #fff; font-size: 9px; font-weight: 700;
      letter-spacing: 1.5px; text-transform: uppercase; padding: 3px 10px;
      white-space: nowrap;
    }
    .tier-option.selected .tier-badge { background: #fff; color: #000; }
    .tier-label { font-size: 13px; font-weight: 700; color: #000; display: block; margin-bottom: 4px; }
    .tier-price { font-size: 22px; font-weight: 700; color: #000; display: block; margin-bottom: 6px; }
    .tier-desc { font-size: 11px; color: #888; line-height: 1.4; display: block; }

    .field-group { margin-bottom: 20px; }
    .field-group label { display: block; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: #333; margin-bottom: 8px; }
    .req { font-weight: 400; color: #999; }
    .field-input {
      width: 100%; padding: 12px 14px; border: 1px solid #ddd;
      font-size: 14px; font-family: inherit; color: #000;
      box-sizing: border-box; outline: none; transition: border-color 0.15s;
      background: #fff;
    }
    .field-input:focus { border-color: #000; }
    .field-textarea {
      width: 100%; padding: 12px 14px; border: 1px solid #ddd;
      font-size: 14px; font-family: inherit; color: #000;
      box-sizing: border-box; outline: none; resize: vertical; min-height: 100px;
      transition: border-color 0.15s; background: #fff;
    }
    .field-textarea:focus { border-color: #000; }
    .char-count { font-size: 11px; color: #bbb; text-align: right; margin-top: 4px; }
    .char-count.over { color: #c00; }

    .divider { border: none; border-top: 1px solid #eee; margin: 24px 0; }

    .btn-primary {
      display: block; width: 100%; background: #000; color: #fff;
      font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
      padding: 16px; border: none; cursor: pointer; font-family: inherit;
      transition: opacity 0.15s; margin-top: 8px;
    }
    .btn-primary:hover { opacity: 0.85; }
    .btn-primary:disabled { opacity: 0.5; cursor: default; }

    .btn-secondary {
      display: block; width: 100%; background: #fff; color: #000;
      font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
      padding: 16px; border: 2px solid #000; cursor: pointer; font-family: inherit;
      transition: all 0.15s; margin-top: 12px;
    }
    .btn-secondary:hover { background: #f5f5f5; }

    .form-error { display: none; color: #c00; font-size: 13px; margin-bottom: 16px; padding: 10px 14px; background: #fff5f5; border-left: 3px solid #c00; }
    .form-error.visible { display: block; }

    .fine-print { font-size: 11px; color: #999; line-height: 1.5; margin-top: 12px; }
    .fine-print a { color: #000; text-decoration: underline; }

    /* Heard First pitch */
    .hf-pitch {
      background: #f9f9f9; border: 1px solid #eee; padding: 20px 24px;
      margin-bottom: 24px;
    }
    .hf-pitch h3 { font-size: 14px; font-weight: 700; margin: 0 0 6px; color: #000; }
    .hf-pitch p { font-size: 13px; color: #555; line-height: 1.5; margin: 0 0 12px; }
    .hf-pitch a { font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: #000; text-decoration: none; border-bottom: 1px solid #000; }

    /* Success */
    .success-card { text-align: center; padding: 60px 40px; border: 1px solid #eee; }
    .success-icon { font-size: 48px; margin-bottom: 16px; }
    .success-card h2 { font-family: 'Barlow Condensed', sans-serif; font-size: 40px; font-weight: 700; text-transform: uppercase; margin: 0 0 12px; }
    .success-card p { font-size: 15px; color: #555; line-height: 1.7; margin: 0; }
  </style>
</head>
<body data-page="submit">
  <div id="player-bar">
    <img class="player-art" src="assets/brand/logo-black.jpg" alt="">
    <div class="player-controls">
      <button class="prev-btn" title="Previous">&#9198;</button>
      <button class="play-btn" title="Play">&#9654;</button>
      <button class="next-btn" title="Next">&#9197;</button>
    </div>
    <div class="player-info">
      <div class="player-title">Select a track to play</div>
      <div class="player-source">SPOTIFY</div>
    </div>
    <div class="player-right">
      <button class="heart-btn" title="Like">&#9825;</button>
      <input type="range" class="volume-slider" min="0" max="1" step="0.05" value="0.8">
    </div>
    <div class="player-progress"><div class="player-progress-fill"></div></div>
  </div>

  <aside id="sidebar">
    <a href="index.html" class="sidebar-brand">
      <img src="assets/brand/logo-black.jpg" alt="BTD">
      <span class="brand-name">Before The Data</span>
    </a>
    <nav>
      <a href="index.html"><span class="nav-icon">â—ˆ</span> Discover</a>
      <a href="new-music.html"><span class="nav-icon">â™ª</span> New Music</a>
      <a href="popular.html"><span class="nav-icon">â–²</span> Popular</a>
      <a href="search.html"><span class="nav-icon">âŒ•</span> Search</a>
      <a href="submit.html" class="active"><span class="nav-icon">ðŸ“¬</span> Submit Music</a>
    </nav>
    <div class="sidebar-footer">
      <a href="about.html">About</a>
      <a href="heard-first.html" style="font-weight:700;">â˜… Heard First</a>
      <a href="contact.html">Contact</a>
    </div>
  </aside>

  <main id="main">
    <div class="submit-wrap">
      <div class="submit-header">
        <h1>Submit Your Music</h1>
        <p>Chad listens to everything personally. Before The Data has been finding artists before anyone else since 2007. Billie Eilish, Lorde, Halsey, LANY, Daniel Caesar. All found here first.</p>
      </div>

      <!-- STEP 1: Email Gate -->
      <div id="step-email" class="step-block active">
        <div class="submit-card">
          <h2>First, your email</h2>
          <p>We'll send you a confirmation and follow-up at this address. No spam, ever.</p>
          <div id="email-error" class="form-error"></div>
          <form id="email-form">
            <div class="field-group">
              <label for="gate-email">Your Email <span class="req">*</span></label>
              <input type="email" id="gate-email" class="field-input" placeholder="artist@example.com" required autocomplete="email">
            </div>
            <button type="submit" class="btn-primary" id="email-submit-btn">Continue â†’</button>
          </form>
        </div>
      </div>

      <!-- STEP 2: Submission Form + Tier Choice -->
      <div id="step-form" class="step-block">

        <div class="submit-card">
          <h2>Your Track Info</h2>
          <p>Fill this out. The more detail, the better.</p>

          <div id="submit-error" class="form-error"></div>

          <form id="submit-form">
            <div class="field-group">
              <label for="spotify-url">Spotify Track URL <span class="req">*</span></label>
              <input type="url" id="spotify-url" class="field-input" placeholder="https://open.spotify.com/track/..." required>
            </div>
            <div class="field-group">
              <label for="artist-name">Artist Name <span class="req">*</span></label>
              <input type="text" id="artist-name" class="field-input" placeholder="Your artist name" required>
            </div>
            <div class="field-group">
              <label for="genre">Genre <span class="req">*</span></label>
              <input type="text" id="genre" class="field-input" placeholder="e.g. Alt-R&B, Bedroom Pop, Indie Electronic" required>
            </div>
            <hr class="divider">
            <div class="field-group">
              <label for="instagram-url">Instagram URL</label>
              <input type="url" id="instagram-url" class="field-input" placeholder="https://instagram.com/yourhandle">
            </div>
            <div class="field-group">
              <label for="tiktok-url">TikTok URL</label>
              <input type="url" id="tiktok-url" class="field-input" placeholder="https://tiktok.com/@yourhandle">
            </div>
            <div class="field-group">
              <label for="bio">Short Bio <span class="req">(max 300 chars)</span></label>
              <textarea id="bio" class="field-textarea" placeholder="Who you are, where you're from, what this track is about..." maxlength="300"></textarea>
              <div class="char-count"><span id="bio-count">0</span>/300</div>
            </div>

            <hr class="divider">

            <!-- Tier choice -->
            <div class="field-group">
              <label>Submission Type</label>
              <div class="tier-toggle">
                <div class="tier-option" id="tier-free" onclick="selectTier('free')">
                  <span class="tier-label">Standard</span>
                  <span class="tier-price">Free</span>
                  <span class="tier-desc">Goes into the queue. No guarantee on timeline.</span>
                </div>
                <div class="tier-option selected" id="tier-paid" onclick="selectTier('paid')">
                  <span class="tier-badge">Recommended</span>
                  <span class="tier-label">Guaranteed Listen</span>
                  <span class="tier-price">$5</span>
                  <span class="tier-desc">Chad personally listens within 7 days. Jumps to the top.</span>
                </div>
              </div>
            </div>

            <button type="submit" class="btn-primary" id="submit-btn">Submit Track â†’</button>
            <p class="fine-print">By submitting you confirm this is your original work. Paid submissions are processed via Stripe. No refunds on paid submissions.</p>
          </form>
        </div>

        <div class="hf-pitch">
          <h3>â˜… Heard First: A&R Intel, 48 Hours Early</h3>
          <p>We run a 24/7 AI agent scanning TikTok for artists worth watching. Chad curates every pick. Subscribers get the signal 48 hours before anyone else, plus the full A&R data behind it.</p>
          <a href="heard-first.html">Learn more â†’</a>
        </div>

      </div>

      <!-- SUCCESS STATE -->
      <div id="step-success" class="step-block">
        <div class="success-card">
          <div class="success-icon">ðŸ“¬</div>
          <h2>We Got It.</h2>
          <p id="success-msg">Your track is in the queue. No guarantee on timeline. But it's in there.<br><br>Want a guaranteed listen? <a href="submit.html" style="color:#000;font-weight:700;">Submit again for $5</a> and Chad personally listens within 7 days.</p>
        </div>
      </div>

    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/player.js"></script>
  <script>
    const FIREBASE_KEY = 'AIzaSyAI2Nrt4PsnOB0DyLa4yrWYyY39Oblzcec';
    const FIREBASE_BASE = 'https://firestore.googleapis.com/v1/projects/ar-scouting-dashboard/databases/(default)/documents';

    const params = new URLSearchParams(window.location.search);
    const paidReturn = params.get('paid') === '1';
    // Clean up URL immediately so a second submission doesn't inherit paid=1
    if (paidReturn) {
      try { window.history.replaceState({}, '', window.location.pathname); } catch(e) {}
    }
    const sessionId = params.get('session_id') || '';

    let capturedEmail = '';
    let selectedTier = 'paid'; // default to recommended

    try { capturedEmail = localStorage.getItem('btd_submit_email') || ''; } catch(e) {}

    function showStep(id) {
      document.querySelectorAll('.step-block').forEach(el => el.classList.remove('active'));
      document.getElementById(id)?.classList.add('active');
    }

    function selectTier(tier) {
      selectedTier = tier;
      document.getElementById('tier-free').classList.toggle('selected', tier === 'free');
      document.getElementById('tier-paid').classList.toggle('selected', tier === 'paid');
      const btn = document.getElementById('submit-btn');
      btn.textContent = tier === 'paid' ? 'Pay $5 & Submit â†’' : 'Submit Track (Free) â†’';
    }

    // On load
    if (paidReturn) {
      // Came back from Stripe â€” show form, prefill as paid, skip tier choice
      showStep('step-form');
      document.querySelector('.tier-toggle').style.display = 'none';
      selectedTier = 'paid';
    } else if (capturedEmail) {
      showStep('step-form');
    }

    // Email gate
    document.getElementById('email-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('gate-email').value.trim();
      if (!email) return;
      const btn = document.getElementById('email-submit-btn');
      btn.textContent = 'Saving...'; btn.disabled = true;

      try {
        const id = email.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        await fetch(`${FIREBASE_BASE}/config/btd_sub_${id}?key=${FIREBASE_KEY}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fields: {
            email: { stringValue: email },
            subscribedAt: { stringValue: new Date().toISOString() },
            source: { stringValue: 'submit-gate' },
            tier: { stringValue: 'free' }
          }})
        });
        capturedEmail = email;
        try { localStorage.setItem('btd_submit_email', email); } catch(e) {}
        showStep('step-form');
      } catch(err) {
        const errEl = document.getElementById('email-error');
        errEl.textContent = 'Something went wrong. Try again.';
        errEl.classList.add('visible');
        btn.textContent = 'Continue â†’'; btn.disabled = false;
      }
    });

    // Bio counter
    const bioField = document.getElementById('bio');
    const bioCount = document.getElementById('bio-count');
    bioField.addEventListener('input', () => {
      const len = bioField.value.length;
      bioCount.textContent = len;
      bioCount.parentElement.classList.toggle('over', len > 300);
    });

    // Submission form
    document.getElementById('submit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      const errEl = document.getElementById('submit-error');
      btn.textContent = 'Submitting...'; btn.disabled = true;
      errEl.classList.remove('visible');

      const spotifyUrl = document.getElementById('spotify-url').value.trim();
      const artistName = document.getElementById('artist-name').value.trim();
      const genre = document.getElementById('genre').value.trim();
      const instagramUrl = document.getElementById('instagram-url').value.trim();
      const tiktokUrl = document.getElementById('tiktok-url').value.trim();
      const bio = document.getElementById('bio').value.trim();

      // If paid tier and NOT returning from Stripe â€” go to Stripe first
      if (selectedTier === 'paid' && !paidReturn) {
        // Store form data so we can restore after return
        try {
          localStorage.setItem('btd_pending_submission', JSON.stringify({ spotifyUrl, artistName, genre, instagramUrl, tiktokUrl, bio }));
        } catch(e) {}
        // Redirect to Stripe
        btn.textContent = 'Redirecting to checkout...';
        try {
          const res = await fetch('/api/create-submit-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: capturedEmail })
          });
          const data = await res.json();
          if (data.url) { window.location.href = data.url; return; }
          throw new Error(data.error || 'No checkout URL');
        } catch(err) {
          errEl.textContent = 'Payment failed to load. Please try again.';
          errEl.classList.add('visible');
          btn.textContent = 'Pay $5 & Submit â†’'; btn.disabled = false;
        }
        return;
      }

      // Free submit OR returning from paid Stripe
      // Try to restore pending submission data if returning from Stripe
      let finalData = { spotifyUrl, artistName, genre, instagramUrl, tiktokUrl, bio };
      if (paidReturn) {
        try {
          const pending = JSON.parse(localStorage.getItem('btd_pending_submission') || '{}');
          if (pending.spotifyUrl) finalData = { ...pending };
        } catch(e) {}
        // If still no spotifyUrl after restore attempt, form data is missing â€” use what's in the form
        if (!finalData.spotifyUrl) {
          finalData = { spotifyUrl, artistName, genre, instagramUrl, tiktokUrl, bio };
        }
        // Final check â€” if spotifyUrl is still empty, we can't submit
        if (!finalData.spotifyUrl || !finalData.artistName || !finalData.genre) {
          errEl.textContent = 'Your payment went through but we lost your form data. Please fill in the fields above and submit again â€” you will not be charged again.';
          errEl.classList.add('visible');
          btn.textContent = 'Pay $5 & Submit â†’';
          btn.disabled = false;
          return;
        }
      }

      try {
        const res = await fetch('/api/submit-music', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: capturedEmail,
            ...finalData,
            tier: paidReturn ? 'paid' : 'free',
            stripeSessionId: sessionId
          })
        });
        if (!res.ok) {
          const d = await res.json().catch(() => ({}));
          throw new Error(d.error || 'Submission failed');
        }
        try { localStorage.removeItem('btd_submit_email'); localStorage.removeItem('btd_pending_submission'); } catch(e) {}
        const successMsg = document.getElementById('success-msg');
        if (paidReturn) {
          successMsg.innerHTML = "Your track is in the guaranteed listen queue. Chad personally listens within 7 days. You'll hear back either way.<br><br>Check your inbox for a confirmation.";
        }
        showStep('step-success');
      } catch(err) {
        errEl.textContent = 'Something went wrong. Try again or email hello@beforethedata.com';
        errEl.classList.add('visible');
        btn.textContent = selectedTier === 'paid' ? 'Pay $5 & Submit â†’' : 'Submit Track (Free) â†’';
        btn.disabled = false;
      }
    });

    // Restore form after Stripe redirect
    if (paidReturn) {
      try {
        const pending = JSON.parse(localStorage.getItem('btd_pending_submission') || '{}');
        if (pending.spotifyUrl) {
          document.getElementById('spotify-url').value = pending.spotifyUrl || '';
          document.getElementById('artist-name').value = pending.artistName || '';
          document.getElementById('genre').value = pending.genre || '';
          document.getElementById('instagram-url').value = pending.instagramUrl || '';
          document.getElementById('tiktok-url').value = pending.tiktokUrl || '';
          document.getElementById('bio').value = pending.bio || '';
          bioCount.textContent = (pending.bio || '').length;
        }
      } catch(e) {}
      // Update submit button for paid flow
      document.getElementById('submit-btn').textContent = 'Submit Track â†’';
    } else {
      // Default: recommended = paid tier
      selectTier('paid');
    }
  </script>
</body>
</html>
